<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>原生安卓6.0“去感叹号” | maodahua</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="先说一点废话平时自己喜欢玩儿服务器，所以自己就买了一个AWS来搭建自己的VPN服务器，稳如狗，从来不掉线，就自己一个人使用全部的带宽，非常爽。说道为什么翻墙，那肯定是为了访问Google，那么问题来了，谷歌一系列产品带来的良好的用户体验以及各种强大的功能让我爱不释手，自然想投靠谷歌了。然而手机上的手机却是iPhone，所以立刻下定决心要换一个安卓的手机来用用，而且应该是要有谷歌服务框架的手机，最好">
<meta property="og:type" content="article">
<meta property="og:title" content="原生安卓6.0“去感叹号”">
<meta property="og:url" content="http://yoursite.com/2016/06/06/原生安卓6-0“去感叹号”/index.html">
<meta property="og:site_name" content="maodahua">
<meta property="og:description" content="先说一点废话平时自己喜欢玩儿服务器，所以自己就买了一个AWS来搭建自己的VPN服务器，稳如狗，从来不掉线，就自己一个人使用全部的带宽，非常爽。说道为什么翻墙，那肯定是为了访问Google，那么问题来了，谷歌一系列产品带来的良好的用户体验以及各种强大的功能让我爱不释手，自然想投靠谷歌了。然而手机上的手机却是iPhone，所以立刻下定决心要换一个安卓的手机来用用，而且应该是要有谷歌服务框架的手机，最好">
<meta property="og:updated_time" content="2016-06-05T17:04:41.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="原生安卓6.0“去感叹号”">
<meta name="twitter:description" content="先说一点废话平时自己喜欢玩儿服务器，所以自己就买了一个AWS来搭建自己的VPN服务器，稳如狗，从来不掉线，就自己一个人使用全部的带宽，非常爽。说道为什么翻墙，那肯定是为了访问Google，那么问题来了，谷歌一系列产品带来的良好的用户体验以及各种强大的功能让我爱不释手，自然想投靠谷歌了。然而手机上的手机却是iPhone，所以立刻下定决心要换一个安卓的手机来用用，而且应该是要有谷歌服务框架的手机，最好">
<meta name="twitter:creator" content="@maodahua">
<link rel="publisher" href="maodahua16@gmail.com">
  
    <link rel="alternative" href="/atom.xml" title="maodahua" type="application/atom+xml">
  
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  
</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="overlay"></div>
  <div id="header-outer" class="outer">
    <div id="profile_img">
      <img id="circle_img" src="https://raw.githubusercontent.com/maodahua/maodahua.github.io/master/image/touxiang.JPG" />
    </div>
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">maodahua</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Write the code.</a>
        </h2>
      
    </div>
    <div id="header-menu">
      <nav id="main-nav">
        <ul>
        
          <li><a href="/"><i class="fa fa-home icon-setting"></i></a></li>
        
          <li><a href="/archives"><i class="fa fa-archive icon-setting"></i></a></li>
        
          <li><a href="/about"><i class="fa fa-user icon-setting"></i></a></li>
        
        
          <li><a href="/atom.xml"><i class="fa fa-rss %> icon-setting"></i></a></li>
        
        </ul>
      </nav>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-原生安卓6-0“去感叹号”" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/06/06/原生安卓6-0“去感叹号”/" class="article-date">
  <time datetime="2016-06-05T17:02:24.000Z" itemprop="datePublished">2016-06-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/服务器/">服务器</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      原生安卓6.0“去感叹号”
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="先说一点废话"><a href="#先说一点废话" class="headerlink" title="先说一点废话"></a>先说一点废话</h1><p>平时自己喜欢玩儿服务器，所以自己就买了一个AWS来搭建自己的VPN服务器，稳如狗，从来不掉线，就自己一个人使用全部的带宽，非常爽。说道为什么翻墙，那肯定是为了访问<code>Google</code>，那么问题来了，谷歌一系列产品带来的良好的用户体验以及各种强大的功能让我爱不释手，自然想投靠谷歌了。然而手机上的手机却是<code>iPhone</code>，所以立刻下定决心要换一个安卓的手机来用用，而且应该是要有谷歌服务框架的手机，最好是原生的安卓！毕竟国内的安卓手机都不带谷歌服务框架的，具体原因你懂得，而且预装各种流氓软件，不root还不给你卸载。这么一盘算下来，我就所订了最新的一款谷歌亲儿子，<code>Nexus 6P</code>。由华为代工，虽然网上早已诟病高通骁龙810这颗soc的功耗，但是我等不及了。经过几个月的筹钱，终于在前几天拿到了一个台湾销售的Nexus 6P。激动的心情无以言表，打开手机，把玩一下，好不夸张的说，那么顺畅的安卓手机我还是第一次见。（<code>PS：之前一直在用iPhone，所以安卓手机接触得少</code>）<strong> 但是！</strong> <strong> 但是！！</strong> <strong> 但是！！！</strong> 不管是使用<code>移动数据</code>还是连上<code>WiFi</code>，都会在通知栏上显示一个感叹号！这是什么鬼，而且还显示无法连接到internet，我这不是好好的在上网么？！WTF<br>!作为强迫症患者的我，即使它能上网也不能抚慰我心里面的不安。于是我上网搜索了起来。  </p>
<hr>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>经过搜索，我才知道，原来早在安卓5.0的时候就引入了一种全新的网络评估机制来评估网络状况，当有网络连接请求的时候回选一个最好的网络进行连接。网上还有人直接po出了源码，大概看了一下。简单的来说，如果你的网络不是VPN的话，就会调用isCaptivePortal()这个方法来进行网络状况的判定，根据判定的结果决定是否要选用这个网络进行连接。好了，天朝为什么会出现这个问题？罪魁祸首就是这个方法！调用这个方法的时候回访问一个谷歌的服务器站点<code>clients3.google.com/generate_204</code>并根据HTTP的状态返回值来判断网络连通状况。然后，当你看到里面包含<code>google</code>字样的时候，或许你就应该懂了什么。所以那个感叹号一直存在，甚至有网友说连着WiFi突然开始跑流量，都是他的锅。😒  </p>
<p>当时一般人都会想到，那就屏蔽这个方法呗，其实我的想法也是这样的，但是经过网上大神的深入原发分析发现，这个方法的作用远不止这个，它还很重要，需要判断当前的网络是否需要登录，比如周末没事带着手机去星巴克这种WiFi需要登录的场所，当连接这些热点的时候，安卓会弹出对话框问你是否需要登录，这个功能就依靠这个方法。大神分析源码之后原理如下：  </p>
<p>安卓首先访问上面提到的网址，这个网址如字面所说，会返回一个<code>http204</code>。204的意识表示的是空内容。如果当前的WiFi需要登录，那么在访问的时候就会跳转到登录的页面，这个时候的返回值也肯定就不是204了。通过这个方法，完全还区分了当前的WiFi是否需要登录，真的还是佩服想出这个方法的程序猿。  </p>
<hr>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>经过上面的分析，我们知道，简单的屏蔽那个方法不是一个明智的选择，但是不屏蔽那个网址的话，会有感叹号影响美观甚至存在偷跑流量的可能性。那为何不自己搭建一个服务器，然后默认访问自己的服务器，返回一个<code>http204</code>不就解决了问题吗？当然，替换的办法大概有两种，一是可以使用一个软件来替换网址，但是这个软件需要root权限。二是使用adb工具来替换。因为我的手机毕竟买来还没有一个星期，所以我肯定是不愿意root的，而且我是一个从iPhone过渡过来的用户，肯定是不喜欢折腾这些有的没的。下面就从零开始，来实现<strong>去感叹号</strong>。  </p>
<hr>
<h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><ul>
<li>服务器：阿里云  </li>
<li>操作系统：CentOS 7</li>
<li>adb工具  </li>
</ul>
<hr>
<h1 id="搭建服务器"><a href="#搭建服务器" class="headerlink" title="搭建服务器"></a>搭建服务器</h1><p>经过这个部分，我们需要在服务器上搭建一个web服务器最熟悉的是Apache，并访问服务器之后会返回一个204。  </p>
<h2 id="安装Apache"><a href="#安装Apache" class="headerlink" title="安装Apache"></a>安装Apache</h2><p>在服务器上，可以很简单的使用CentOS的包管理器安装。当然，我的建议是连接服务器的时候使用root身份。输入下面的命令：  </p>
<pre><code>yum install httpd  
</code></pre><p>然后后面跟着提示走，很快就安装完<code>Apache</code>了。完成之后需要启动这个服务，在上一篇文章中介绍过CentOS 7启动服务和之前的不同，执行以下命令就可以启动了  </p>
<pre><code>systemctl start httpd.service  
</code></pre><p>好了，现在可以输入你的服务器的IP地址在浏览器中，如果出现一个apache的页面，那就说明http服务器已经安装成功并且正在运行了。最后，不得不做的一个事情就是让Apache开机自启，不然万一有一天你的服务器崩溃了重启之后又会出现感叹号。 </p>
<pre><code>systemctl enable httpd.service
</code></pre><p>如果安装成功又不能访问的话，考虑一下防火墙规则和SELinux，但是一般的云服务器是默认关闭这些的，修改一下安全组就可以了。</p>
<h2 id="开启Apache的Rewrite模块"><a href="#开启Apache的Rewrite模块" class="headerlink" title="开启Apache的Rewrite模块"></a>开启Apache的Rewrite模块</h2><p>为什么需要使用这个模块呢，因为我的第一个想法是使用Apache+PHP来返回一个204，能够返回204，但是配置到手机上之后还是有感叹号，我就在想可能是我不知道的原因或者有什么其他需要注意的地方我没注意，所以在这里也抛砖引玉，如果有哪一个大神能够告诉我，欢迎<strong>联系我</strong>，联系方式见<strong>主页</strong>。后面尝试之后使用Apache的这个模块能成功，所以本文介绍这个方法。<br>Rewite模块在CentOS 7上是默认开启的，可以通过一下命令查看已经加载的模块：  </p>
<pre><code>apachectl -M | sort  
</code></pre><p>执行后会列出来已经开启的模块，在里面如果没有找到Rewrite的话，那就是可能由于一些原因被屏蔽了。在<code>/etc/httpd/conf.modules.d/00-base.conf</code>这个配置文件中加上一条语句即可。  </p>
<pre><code>LoadModule rewrite_module modules/mod_rewrite.so  
</code></pre><h2 id="配置并启用-htaccess文件"><a href="#配置并启用-htaccess文件" class="headerlink" title="配置并启用.htaccess文件"></a>配置并启用.htaccess文件</h2><p>我们需要使用这个文件配置Apache的重定向规则，在默认情况下，这个文件应该保存在<code>/var/www/html</code>这个目录。现在就需要编辑这个文件。  </p>
<pre><code>cd /var/www/html
vim .htaccess  
</code></pre><p>当然，如果之前没有创建过这个文件的话打开的会是一个空文件，然后输入如下的规则：  </p>
<pre><code>RewriteEngine On
RewriteCond %{REQUEST_URI} /generate_204$
RewriteRule $ / [R=204]  
</code></pre><p>如果不懂上面的规则是什么意思的话，那就直接复制就好，这里面涉及到正则表达式的内容。保存退出之后我们需要在Apache的配置文件中让刚才的配置生效。  </p>
<pre><code>vim /etc/httpd/conf/httpd.conf  
</code></pre><p>然后找到<code>&lt;directory /var/www/html&gt;</code>在里面有一句<code>AllowOverride None</code>需要修改  </p>
<pre><code>&lt;Directory /var/www/html&gt;
...
    AllowOverride All
...
 &lt;/Directory&gt;  
</code></pre><p>保存退出之后，重启Apache  </p>
<pre><code>systemctl restart httpd  
</code></pre><p>好了，现在的配置工作已经完成，让我们来检验一下，那怎么检验呢？当然可以使用<code>Wireshark</code>来抓包分析，但是大可不必。我在网上找到一个网站，来测试返回值的。<a href="https://httpstatus.io/" target="_blank" rel="external">查看HTTP返回值</a><br>在上面的网站中输入你的服务器IP就行了，如果备案之后也使用的域名的话，那就可以直接输入网址，稍等片刻下方出现的是204的话，就可以开心一把了。  </p>
<hr>
<h1 id="替换网站"><a href="#替换网站" class="headerlink" title="替换网站"></a>替换网站</h1><p>这里需要使用到<code>adb</code>，手机上要打开<code>USB调试功能</code>。使用数据线连接电脑，然后打开切换到adb所在的目录或者把adb加入系统的环境变量。  </p>
<pre><code>adb shell &quot;settings put global captive_portal_server XXX.XXX.XXX.XXX&quot;  
</code></pre><p>XXX替换为自己服务器的外网IP地址或者域名，记住，只写地址，不用写其他的东西，因为我们做了重定向。<br>完成之后拔了数据线，重新连接WiFi或者打开移动数据，会发现感叹号不在了，现在可以开一瓶酒庆祝了。当然，感叹号消失的时间和访问服务器所花费的时间成正比，所以选择国内的服务器肯定是最好的选择。</p>
<hr>
<h1 id="最后扯淡"><a href="#最后扯淡" class="headerlink" title="最后扯淡"></a>最后扯淡</h1><p>如果自己的服务器关闭了，或者人肉翻墙了，觉得访问速度慢，可以使用  </p>
<pre><code>adb shell &quot;settings delete global captive_portal_server&quot;  
</code></pre><p>来回复原来的设置。<br>当然，我现在想说的，Nexus 6P真的很顺滑，哈哈哈，让我爱不释手。自己也很庆幸拥有一些服务器方面的知识，能够在出现问题的时候想到办法去解决它，并且成功解决。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/06/06/原生安卓6-0“去感叹号”/" data-id="cip5bvedt0009hp015fhvlcud" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2016/04/17/CentOS7上自定义系统服务/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">CentOS7上自定义系统服务</div>
    </a>
  
</nav>

  
</article>

</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 ML<br>
      <a href="https://github.com/ken8203/hexo-theme-alberta" target="_blank">Alberta</a> by <a href="http://jaychung.tw" target="_blank">jaychung</a>. Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Thank <a href="http://subtlepatterns.com/" target="_blank">Subtlepatterns</a>
    </div>
  </div>
</footer>
    </div>
    
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="//imsky.github.io/holder/holder.js"></script>

  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>